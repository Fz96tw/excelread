<!DOCTYPE html>
<html>
<head>
    <title>Config Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0 0;
            color: #414040;
        }

        h3 { margin-bottom: 4px; }
        ol { margin-top: 4px; }
        .sync-desc { margin: 0 0 4px 0; }     

        form label { display: inline-block; width: 150px; vertical-align: middle; }
        form input[type="text"] { display: inline-block; vertical-align: middle; width: 300px; margin-bottom: 10px; }
        form button { margin-top: 10px; }

        .menu-bar #btn-exit { margin-left: auto; }
        .menu-bar {
            display: flex;
            padding: 4px 20px;
            gap: 20px;
            background-color: rgb(11, 48, 104) !important;
            position: relative;
            align-items: center;
        }
        .menu-bar button img { height: 40px; margin-bottom: 5px; }
        .menu-bar button span { color: white; font-size: 18px; font-weight: normal; }
        .menu-bar::before {
            content: "";
            position: relative;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            pointer-events: none;
            z-index: 1;
        }
        .menu-bar button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
        }
        .menu-bar button:hover { background-color: rgba(255, 255, 255, 0.2); }
        .menu-bar button.active { background-color: rgba(255, 255, 255, 0.4); }

        .section-content { display: none; padding: 20px; }
        .section-content.active { display: block; }

        img.banner { width: 100%; max-height: 300px; object-fit: cover; display: block; }

        .left-form {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            margin: 0;
            width: 80px; /* will override for schedule modal */
        }
        .left-form label { display: block; font-weight: normal; width: 300px; }
        .left-form input, .left-form button { width: 100%; box-sizing: border-box; }
        .left-form button { margin-top: 0; }
        .page-content { padding: 0 50px; box-sizing: border-box; }

        .table-btn {
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .table-btn:hover { background-color: #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .table-btn img { height: 20px; vertical-align: middle; }

        /* === Modal === */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 20px 30px;
            width: 500px;
            max-width: 90%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            color: #414040;
        }
        .close { float: right; font-size: 22px; font-weight: bold; cursor: pointer; color: #888; }
        .close:hover { color: #000; }

        #scheduleForm label { display: block; font-weight: normal; margin-top: 10px; margin-bottom: 4px; }
        #scheduleForm input, #scheduleForm textarea {
            padding: 6px; margin-bottom: 8px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; box-sizing: border-box;
        }

        /* Toast styling */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 14px;
            position: fixed;
            z-index: 1000;
            right: 20px; top: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 40px; }

    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>

<body>
    <img src="{{ banner_path }}" alt="Banner" class="banner">

    <div class="menu-bar">
        <button id="btn-section1"><img src="/static/jiraicon.png" alt="Jira Icon"><span>Jira</span></button>
        <button id="btn-section2" class="active"><img src="/static/sharepointicontransparent.png" alt="SharePoint Icon"><span>Sharepoint</span></button>
        <button id="btn-section4"><img src="/static/llmicon.png" alt="LLM Icon"><span>LLM Model</span></button>
        <button id="btn-section3"><img src="/static/debuglogs.png" alt="Debug Logs Icon"><span>Logs</span></button>
        <!-- Display user login -->
        <button id="btn-exit" onclick="window.location.href='/logout'"><img src="/static/exiticon.png" alt="Exit Icon"><span>Logout</span></button>
    </div>

    <div class="page-content">
        <!-- Section 1: Jira -->
        <div id="section1" class="section-content">
            <h2><img src="/static/jiraicon.jpg" alt="Jira Icon" style="height:32px; vertical-align:bottom; margin-right:2px;">Jira Connection Info</h2>
            <form method="POST" class="left-form">
                <label>Jira Cloud URL:</label>
                <input type="text" name="jira_url" value="{{ foo_values.get('jira_url', '') }}">
                <label>Jira Email:</label>
                <input type="text" name="jira_user" value="{{ foo_values.get('jira_user', '') }}">
                <label>Jira API Token:</label>
                <input type="text" name="jira_token" value="{{ foo_values.get('jira_token', '') }}">
                <button type="submit" name="save_foo"><img src="/static/saveicontransparent.png" style="height:40px; vertical-align:middle; margin-right:2px;">Save</button>
            </form>
        </div>

        <!-- Section 2: Sharepoint -->
        <div id="section2" class="section-content active">
            Logged in user: {{username}}
<br>
            Sharepoint site permissions:
            {% if logged_in %}
                <button type="button" title="Logged in">‚úÖ Authorized</button>
            {% else %}
                <button type="button" class="login-btn" onclick="openLoginPopup(this)" title="Login">üîê Login Required</button>
            {% endif %}
    
    
<br><br>
            <h2><img src="/static/excelicon.jpg" style="height:28px; vertical-align:bottom; margin-right:2px;">Add Excel file to connect with Jira</h2>
            <form method="POST" class="left-form">
                <label for="bar_value">Direct Sharepoint URL path to file:</label>
                <input type="text" name="bar_value" id="bar_value" placeholder="https://...">
                <button type="submit" name="add_bar"><img src="/static/connect-icon-gears.png" style="height:40px; vertical-align:middle; margin-right:2px;">Connect</button>
            </form>
<br><br>
            <h2><img src="/static/sharepointicon.jpg" style="height:40px; vertical-align:bottom; margin-right:2px;">
                Active Sharepoint Connections
            </h2>
            <!--p class="sync-desc">Active ShareConnections currently active:</p>
        -->
            <table style="border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th style="text-align:center; padding:6px;"> </th>
                        <th style="text-align:left; padding:6px;"> </th>
                        <th style="text-align:left; padding:6px;"> Username </th>
                        <th style="text-align:left; padding:6px;">Schedule</th>
                        <th style="text-align:center; padding:6px;">Run</th>
                        <th style="text-align:center; padding:6px;">Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% for val in bar_values %}
                    <tr>
                        <td style="text-align:left; padding:6px;">{{ loop.index }}</td>
                        <td style="padding:6px;"><a href="{{ val }}" target="_blank">{{ val }}</a></td>
                        <td style="padding:6px;">foo</td>
                        <td style="text-align:left; padding:6px;">
                            <button type="button" class="table-btn" onclick="openSchedule('{{ val }}')">
                                <img src="/static/schedule-icon.png" alt="Schedule">
                            </button>
                            {% set sched = schedule_dict.get(val) %}
                            {% if sched %}
                                {% if sched.time %}
                                    <span style="font-size:12px; margin-left:6px;">{{sched.mode}} at {{ sched.time }}</span>
                                {% elif sched.interval %}
                                    <span style="font-size:12px; margin-left:6px;">Every {{ sched.interval }} min</span>
                                {% endif %}
                            {% else %}
                                <span style="font-size:12px; margin-left:6px;">None</span>
                            {% endif %}

                        
                        
                        
                        <td style="text-align:center; padding:6px;">
                            <form method="POST">
                                <input type="hidden" name="resync_bar" value="{{ val }}">
                                <button type="submit" class="table-btn" onclick="return confirm('Resync {{ val }}?')"><img src="/static/sync-icon.png" alt="Resync"></button>
                            </form>
                        </td>
                        <td style="text-align:center; padding:6px;">
                            <form method="POST">
                                <input type="hidden" name="remove_bar" value="{{ val }}">
                                <button type="submit" class="table-btn" onclick="return confirm('Remove {{ val }}?')"><img src="/static/delete-icon.png" alt="Delete"></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Section 3: Logs -->
        <div id="section3" class="section-content">
            <h3>Debug Logs</h3>
            <ul>
            {% for file in folder_tree %}
                <li>üìÑ {{ file.name }} ‚Äî <small>{{ file.modified }}</small>
                    <form method="POST" style="display:inline;">
                        <input type="hidden" name="view_log" value="{{ file.name }}">
                        <button type="submit">üëÅÔ∏è View</button>
                    </form>
                </li>
            {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Section 4: LLM Model -->
    <div id="section4" class="section-content">
        <h2><img src="/static/llmicon.png" alt="LLM Icon" style="width:60px;">Configure LLM Model</h2>
        <form id="llmForm" class="left-form">
            <label for="llmSelect">Select LLM Model:</label>
            <select id="llmSelect" name="llm_model">
                <option value="Local" {% if llm_default == 'Local' %}selected{% endif %}>Local</option>
                <option value="OpenAI" {% if llm_default == 'OpenAI' %}selected{% endif %}>OpenAI</option>
            </select>
             <label>OpenAI API Token:</label>
             <input type="text" name="openai_token" value="{{ foo_values.get('jira_token', '') }}">
            <button type="submit" class="table-btn" style="width:150px; margin-top:10px;">
                <img src="/static/saveicontransparent.png" style="height:40px; vertical-align:middle; margin-right:4px;">
                Save
            </button>
        </form>
    </div>


    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><img src="/static/schedule-icon.png" style="height:28px; vertical-align:middle; margin-right:6px;">Schedule File</h2>

<form id="scheduleForm" method="POST" action="/schedule"  style="width:100%;">
  <label>File:</label>
    <textarea id="scheduleFilename" name="filename" readonly rows="4"
        style="width:100%; height:60px; border:none; background-color:#f9f9f9; font-size:14px; resize:none; overflow:auto; word-wrap:break-word; white-space:pre-wrap;"></textarea>

  <table style="width:100%; margin-top:10px; border-collapse:collapse;">
  <tr>
    <!-- Column 1: Time & Interval -->
    <td style="vertical-align:top; text-align:left; padding-right:20px; width:50%;">
      <label style="display:block; margin-bottom:4px;">Time (HH:MM):</label>
      <!--input type="time" id="scheduleTime" name="time" style="width:120px; margin-bottom:10px;">
    -->

        <input type="text" id="scheduleTime" name="time"
        style="width:120px; margin-bottom:10px;"
        placeholder="HH:MM">

      <!----
      <label style="display:flex; align-items:left; gap:4px; margin-bottom:4px; font-weight:normal;">
        <input type="radio" class="scheduleMode" name="mode" value="Hourly" style="margin:0; padding:0;"> Hourly
      </label>
      --->
      <label style="display:flex; align-items:left; gap:4px; margin-bottom:4px; font-weight:normal;">
        <input type="radio" class="scheduleMode" name="mode" value="Daily" style="margin:0; padding:0;"> Daily
      </label>

      <label style="display:flex; align-items:left; gap:4px; margin-bottom:4px; font-weight:normal;">
        <input type="radio" class="scheduleMode" name="mode" value="Weekly" style="margin:0; padding:0;"> Weekly
      </label>

      <div id="weeklyDays" style="margin-top:10px; display:none;">
        <label><input type="checkbox" name="days" value="mon"> Mon</label>
        <label><input type="checkbox" name="days" value="tue"> Tue</label>
        <label><input type="checkbox" name="days" value="wed"> Wed</label>
        <label><input type="checkbox" name="days" value="thu"> Thu</label>
        <label><input type="checkbox" name="days" value="fri"> Fri</label>
        <label><input type="checkbox" name="days" value="sat"> Sat</label>
        <label><input type="checkbox" name="days" value="sun"> Sun</label>
    </div>

    </td>

    <!-- Column 2: Mode Radios -->
    <td style="vertical-align:top; text-align:left; width:50%;">
      <label style="display:block; margin-bottom:4px;">Interval (minutes):</label>
      <input type="number" id="scheduleInterval" name="interval" min="1" style="width:120px;">
    </td>
  </tr>
</table>


  <div style="margin-top:15px; display:flex; gap:10px;">
    <button type="submit" id="scheduleSubmit" class="table-btn" style="width:120px;">
      <img src="/static/saveicontransparent.png" style="height:20px; vertical-align:middle; margin-right:4px;">Save Schedule
    </button>
    <button type="button" id="clearScheduleBtn" class="table-btn" style="background:#d9534f; color:white; width:120px;">
      Clear Schedule
    </button>
  </div>
</form>

      </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script>
        const btnSection1 = document.getElementById('btn-section1');
        const btnSection2 = document.getElementById('btn-section2');
        const btnSection3 = document.getElementById('btn-section3');
        const btnSection4 = document.getElementById('btn-section4');
        const section1 = document.getElementById('section1');
        const section2 = document.getElementById('section2');
        const section3 = document.getElementById('section3');
        const section4 = document.getElementById('section4');


        // Add new section button for LLM model configuration menu bar

        btnSection4.addEventListener('click', () => showSection('section4'));

        // Extend showSection to include section4
        function showSection(sectionToShow) {
            section1.classList.remove('active'); section2.classList.remove('active'); section3.classList.remove('active'); section4.classList.remove('active');
            btnSection1.classList.remove('active'); btnSection2.classList.remove('active'); btnSection3.classList.remove('active'); btnSection4.classList.remove('active');

            if (sectionToShow === 'section1') { section1.classList.add('active'); btnSection1.classList.add('active'); }
            else if (sectionToShow === 'section2') { section2.classList.add('active'); btnSection2.classList.add('active'); }
            else if (sectionToShow === 'section3') { section3.classList.add('active'); btnSection3.classList.add('active'); }
            else { section4.classList.add('active'); btnSection4.classList.add('active'); }
        }

        // Fetch default model from backend on page load
        window.addEventListener('DOMContentLoaded', () => {
            fetch('/getmodel')
            .then(res => res.json())
            .then(data => {
                if(data.default_model) document.getElementById('llmSelect').value = data.default_model;
            })
            .catch(err => console.error('Failed to fetch default model:', err));
        });

        // Submit selected model to backend
        document.getElementById('llmForm').addEventListener('submit', function(event){
            event.preventDefault();
            const selectedModel = document.getElementById('llmSelect').value;
            fetch('/setmodel', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({model: selectedModel})
            })
            .then(res => {
                if(res.ok) showToast(`‚úÖ LLM model set to ${selectedModel}`);
                else showToast('‚ùå Failed to set model', false);
            })
            .catch(()=> showToast('‚ùå Error connecting to server', false));
        });




        btnSection1.addEventListener('click', () => showSection('section1'));
        btnSection2.addEventListener('click', () => showSection('section2'));
        btnSection3.addEventListener('click', () => showSection('section3'));
        showSection('section2');

        let lastLoginBtn = null;
        function openLoginPopup(btn) {
            lastLoginBtn = btn;
            const popup = window.open("/login", "LoginWindow", "width=600,height=700");
            if (!popup) alert("Please allow popups for this site.");
        }

        window.addEventListener("message", function(e) {
            if (e.data === "login-success" && lastLoginBtn) {
                lastLoginBtn.textContent = "‚úÖ Authorized"; lastLoginBtn.title = "Logged in";
            } else if (e.data === "login-failed" && lastLoginBtn) {
                lastLoginBtn.textContent = "‚ùå Authorization Failed"; lastLoginBtn.title = "Login failed";
            }
        });

        // === Schedule Modal & Mutual Exclusivity ===
        const scheduleTime = document.getElementById("scheduleTime");
        const scheduleInterval = document.getElementById("scheduleInterval");

        function enforceMutualExclusivity() {
            const timeVal = scheduleTime.value.trim();
            const intervalVal = scheduleInterval.value.trim();

            // Disable inputs mutually
            scheduleTime.disabled = !!intervalVal;
            scheduleInterval.disabled = !!timeVal;

            // Disable mode radios if interval is used
            modeCheckboxes.forEach(cb => cb.disabled = !!intervalVal);

            // Enable submit button only if at least one input has value
            document.getElementById("scheduleSubmit").disabled = !(timeVal || intervalVal);
        }


        scheduleTime.addEventListener("input", enforceMutualExclusivity);
        scheduleInterval.addEventListener("input", enforceMutualExclusivity);

        function openSchedule(filename) {
            // Load data from schedule_dict (passed into template)
            const sched = scheduleData[filename];  // <-- ensure you inject schedule_dict into JS as scheduleData

            document.getElementById("scheduleFilename").value = filename;
            document.getElementById("scheduleTime").value = sched && sched.time ? sched.time : "";
            document.getElementById("scheduleInterval").value = sched && sched.interval ? sched.interval : "";

            // Clear all mode radios
            document.querySelectorAll("input[name='mode']").forEach(r => r.checked = false);

            if (sched && sched.mode) {
                // Select correct mode
                document.querySelector(`input[name='mode'][value='${sched.mode}']`).checked = true;

                // Show/hide weekly days
                if (sched.mode.toLowerCase() === "weekly") {
                    document.getElementById("weeklyDays").style.display = "block";
                } else {
                    document.getElementById("weeklyDays").style.display = "none";
                }
            }

            // Clear all weekly checkboxes
            document.querySelectorAll("#weeklyDays input[type=checkbox]").forEach(cb => cb.checked = false);

            // Re-check saved days
            if (sched && sched.days) {
                sched.days.forEach(day => {
                    const cb = document.querySelector(`#weeklyDays input[value='${day}']`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById("scheduleModal").style.display = "block";
        }


        document.querySelector(".close").onclick = function() {
            document.getElementById("scheduleModal").style.display = "none";
        };
        window.onclick = function(event) {
            if (event.target === document.getElementById("scheduleModal")) {
                document.getElementById("scheduleModal").style.display = "none";
            }
        };

        function showToast(message, success=true) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.style.backgroundColor = success ? "#4CAF50" : "#d9534f";
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        document.getElementById("scheduleForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const time = scheduleTime.value.trim();
            const interval = scheduleInterval.value.trim();
            if (!time && !interval) { showToast("‚ùå Enter time or interval", false); return; }

            const formData = new FormData(this);
        
            // Find selected mode
            let selectedMode = "";
            modeCheckboxes.forEach(cb => {
                if (cb.checked) selectedMode = cb.value;
            });
            formData.append("mode", selectedMode);

            fetch(this.action, { method: "POST", body: formData })
            .then(response => {
                if (response.ok) { 
                    showToast("‚úÖ Schedule saved successfully"); 
                    document.getElementById("scheduleModal").style.display = "none"; 
                    // Reload the main page to show updated schedules
                    location.reload();
                }
                else { showToast("‚ùå Failed to save schedule", false); }
            })
            .catch(() => showToast("‚ùå Error connecting to server", false));
        });


        const clearScheduleBtn = document.getElementById("clearScheduleBtn");

        clearScheduleBtn.addEventListener("click", function() {
            const filename = document.getElementById("scheduleFilename").value;
            if (!filename) return;

            if (!confirm(`Clear schedule for ${filename}?`)) return;

            fetch('/schedule/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast("‚úÖ Schedule cleared");
                    // Clear inputs in the modal
                    scheduleTime.value = "";
                    scheduleInterval.value = "";
                    // Clear weekly day checkboxes
                    document.querySelectorAll("#weeklyDays input[type=checkbox]").forEach(cb => cb.checked = false);

                    // Hide the weeklyDays section
                    document.getElementById("weeklyDays").style.display = "none";


                    scheduleTime.disabled = false;
                    scheduleInterval.disabled = false;
                    document.getElementById("scheduleSubmit").disabled = true;
                    // Close modal if desired
                    document.getElementById("scheduleModal").style.display = "none";
                    // Reload the main page to show updated schedules
                    location.reload();
                } else {
                    showToast("‚ùå Failed to clear schedule", false);
                }
            })
            .catch(() => showToast("‚ùå Error connecting to server", false));
        });

                // Ensure only one checkbox can be selected
        const modeCheckboxes = document.querySelectorAll(".scheduleMode");
        modeCheckboxes.forEach(cb => {
            cb.addEventListener("change", function() {
                if (this.checked) {
                    modeCheckboxes.forEach(other => {
                        if (other !== this) other.checked = false;
                    });
                }
            });
        });


        flatpickr("#scheduleTime", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",   // 24-hour format
            time_24hr: true
        });


        document.querySelectorAll("input[name='mode']").forEach(radio => {
            radio.addEventListener("change", function() {
                const weeklyDaysDiv = document.getElementById("weeklyDays");
                if (this.value.toLowerCase() === "weekly") {
                    weeklyDaysDiv.style.display = "block";
                } else {
                    weeklyDaysDiv.style.display = "none";
                }
            });
        });

        const scheduleData = {{ schedule_dict | tojson }};

    </script>
</body>
</html>
