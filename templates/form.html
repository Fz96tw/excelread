<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Config Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #e5e7eb;
            --bg-white: #ffffff;
            --border: #d1d5db;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            color: var(--text-dark);
            background: var(--bg-light);
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .left-frame {
            flex: 0 0 260px;
            /*background: #c2c3c5;*/
            background: var(--bg-white);           
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }

        .sidebar-logo {
            width: 100%;
            display: block;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .menu-bar {
            display: flex;
            flex-direction: column;
            padding: 20px 12px;
            gap: 4px;
            flex: 1;
        }

        .menu-bar button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #4a4a4a;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        .menu-bar button:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }

        .menu-bar button.active {
            background: rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .menu-bar button img {
            height: 24px;
            width: 24px;
            object-fit: contain;
            filter: none;
        }

        .menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
            margin: 12px 0;
        }

        .left-footer {
            margin-top: auto;
            padding: 12px;
        }

        /* Main Content */
        .right-frame {
            flex: 1;
            background: var(--bg-light);
            overflow: auto;
        }

        .page-content {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* User Header */
        .user-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .user-header img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-light);
            padding: 8px;
        }

        .user-header span {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Section Content */
        .section-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .card h2 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .card h2 img {
            width: 32px;
            height: 32px;
        }

        /* Forms */
        .left-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 800px;
        }

        .left-form .form-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .left-form label {
            display: block;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
            min-width: 200px;
            flex-shrink: 0;
        }

        .left-form input[type="text"],
        .left-form input[type="number"],
        .left-form select {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .left-form button {
            align-self: flex-start;
        }

        .left-form input:focus,
        .left-form select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons */
        button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--primary);
            color: white;
            width: auto;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        button img {
            width: 18px;
            height: 18px;
            filter: brightness(0) invert(1);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            table-layout: fixed;
            overflow-wrap: break-word;
        }

        thead {
            background: var(--bg-light);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        td a {
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        td button {
            padding: 6px 10px;
            font-size: 13px;
            background: transparent;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        td button:hover {
            background: var(--bg-light);
            transform: none;
            box-shadow: none;
        }

        td button img {
            width: 16px;
            height: 16px;
            filter: none;
        }

        /* Task Queue */
        #taskQueueStatus {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .task-item {
            padding: 16px;
            margin: 12px 0;
            border-radius: 8px;
            border-left: 4px solid var(--border);
            background: var(--bg-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .task-item.pending {
            border-left-color: var(--warning);
            background: #fffbeb;
        }

        .task-item.running {
            border-left-color: var(--primary);
            background: #eff6ff;
        }

        .task-item.completed {
            border-left-color: var(--success);
            background: #f0fdf4;
        }

        .task-item.failed {
            border-left-color: var(--danger);
            background: #fef2f2;
        }

        .task-filename {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .task-times {
            font-size: 12px;
            color: var(--text-light);
        }

        .task-status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending { background: var(--warning); color: white; }
        .status-running { background: var(--primary); color: white; }
        .status-completed { background: var(--success); color: white; }
        .status-failed { background: var(--danger); color: white; }

        /* Log Viewer */
        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            padding: 20px;
            border-radius: 8px;
            height: 70vh;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .log-error { color: #f87171; }
        .log-warning { color: #fbbf24; }
        .log-info { color: #60a5fa; }
        .traceback-block {
            background: #2d1b1b;
            border-left: 3px solid #ef4444;
            padding-left: 12px;
            margin: 8px 0;
            display: block;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-white);
            margin: 5% auto;
            padding: 32px;
            width: 550px;
            max-width: 90%;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .close:hover {
            color: var(--text-dark);
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 300px;
            background: var(--success);
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 16px 24px;
            position: fixed;
            z-index: 2000;
            right: 30px;
            top: 30px;
            font-size: 15px;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: var(--shadow-lg);
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            top: 50px;
        }

        /* Spinner */
        .spinner {
            margin: 30px auto;
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info badges */
        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-light);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-dark);
            margin: 4px 0;
        }

        .auth-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-status.authorized {
            background: #f0fdf4;
            color: var(--success);
        }

        .auth-status.unauthorized {
            background: #fef2f2;
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .left-frame {
                flex: 0 0 70px;
            }
            .menu-bar button span {
                display: none;
            }
            .page-content {
                padding: 20px;
            }
        }

        /* Schedule form improvements */
        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .schedule-option {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .schedule-option:hover {
            border-color: var(--primary);
        }

        .schedule-option input[type="radio"] {
            margin-right: 8px;
        }

        #weeklyDays {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        #weeklyDays label {
            display: flex;
            align-items: center;
            padding: 6px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #weeklyDays label:hover {
            background: var(--primary-light);
            color: white;
        }

        #weeklyDays input[type="checkbox"] {
            margin-right: 4px;
        }
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>
    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>Data scan in progress...</h3>
            <div class="spinner"></div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="left-frame">
            <img src="/static/trinketlogo5.png" alt="Logo" class="sidebar-logo" style="width: 200px; margin-right: 20px;" alt="Logo">
            
            <div class="menu-bar">
                <button id="btn-section1">
                    <img src="/static/jiraicon.png" style="width: 32px; height: 32px;" alt="">
                    <span>Jira</span>
                </button>
                <button id="btn-section4">
                    <img src="/static/llmicon.png" style="width: 24px; height: 24px;" alt="">
                    <span>LLM Model</span>
                </button>
                
                <div class="menu-divider"></div>
                
                <button id="btn-section5">
                    <img src="/static/localfiles.png" alt="">
                    <span>Local Files</span>
                </button>
                <button id="btn-section2">
                    <img src="/static/sharepointicontransparent.png"  style="width: 30px; height: 30px;" alt="">
                    <span>Sharepoint</span>
                </button>
                <button id="btn-section6">
                    <img src="/static/googlesheetsicon.png" alt="">
                    <span>Google Drive</span>
                </button>
                
                <div class="menu-divider"></div>
                
                <button id="btn-section7">
                    <img src="/static/versioninfoicon.png" alt="">
                    <span>Info</span>
                </button>
                <button id="btn-section3">
                    <img src="/static/debuglogs.png" alt="">
                    <span>Debug Logs</span>
                </button>
            </div>

            <div class="left-footer">
                <button id="btn-exit" onclick="window.location.href='/logout'" style="width: 100%; justify-content: flex-start; background: transparent; color: #4a4a4a;">
                    <img src="/static/exiticon.png" alt="">
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="right-frame">
            <div class="page-content">
                <!-- Task Queue Status -->
                <div id="taskQueueStatus" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 18px; font-weight: 600;">📋 Active Tasks</h3>
                        <button onclick="clearAllTasks()" style="padding: 6px 14px; font-size: 13px;">Clear All</button>
                    </div>
                    <div id="taskList"></div>
                </div>

                <!-- Section 1: Jira -->
                <div id="section1" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User" style="width: 50px;" alt="Logo">
                        <span>{{username}}</span>
                    </div>

                    <div class="card">
                        <h2>
                            <img src="/static/jiraicon.jpg" alt="Jira">
                            Jira Connection
                        </h2>
                        <form method="POST" class="left-form">
                            <div class="form-row">
                                <label>Jira Cloud URL</label>
                                <input type="text" name="jira_url" value="{{ foo_values.get('jira_url', '') }}" placeholder="https://your-domain.atlassian.net">
                            </div>
                            <div class="form-row">
                                <label>Jira Email</label>
                                <input type="text" name="jira_user" value="{{ foo_values.get('jira_user', '') }}" placeholder="user@example.com">
                            </div>
                            <div class="form-row">
                                <label>Jira API Token</label>
                                <input type="text" name="jira_token" value="{{ foo_values.get('jira_token', '') }}" placeholder="Your API token">
                            </div>
                            <div class="form-row">
                                <label>Jira Password (if using basic auth)</label>
                                <input type="text" name="jira_password" value="{{ foo_values.get('jira_password', '') }}" placeholder="Optional">
                            </div>
                            <button type="submit" name="save_foo">
                                <!--img src="/static/saveicontransparent.png" alt=""-->
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Section 2: SharePoint -->
                <div id="section2" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User">
                        <div>
                            <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">{{username}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">JIRA: {{ foo_values.get('jira_url', 'Not configured')}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">LLM: {{llm_default}}</div>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                            <span class="auth-status {% if logged_in %}authorized{% else %}unauthorized{% endif %}" style="font-size: 16px;">
                                {% if logged_in %}
                                    ✅ Sharepoint: {{auth_username}}
                                {% else %}
                                    🔒 Sharepoint Login Required
                                {% endif %}
                            </span>
                            {% if logged_in %}
                                <form method="POST" action="/logout_sharepoint" style="margin: 0;">
                                    <button type="submit" class="btn-danger" style="padding: 6px 12px; font-size: 13px;">Revoke</button>
                                </form>
                            {% else %}
                                <button type="button" onclick="openLoginPopup(this)" style="padding: 6px 12px; font-size: 13px;">Login</button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card">
                        <h2>
                            <img src="/static/sharepointicontransparent.png" alt="SharePoint">
                            Share new Excel file with Agent
                        </h2>
                        <form method="POST" class="left-form" action="/add_sharepoint">
                            <div class="form-row">
                                <label>Web URL to Excel file</label>
                                <input type="text" name="bar_value" id="bar_value" placeholder="https://yoursite.sharepoint.com/...">
                            </div>
                            <button type="submit" name="add_bar">
                                <!--img src="/static/shareicon.png" alt=""-->
                                Share
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Excel files shared with Agent</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="width: 40px;"></th>
                                    <th>File URL</th>
                                    <th style="width: 100px; text-align: center;">Actions</th>
                                    <th style="width: 100px;">Schedule</th>
                                    <th style="width: 100px;">Unshare</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for val in shared_files_sharepoint %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><img src="/static/excelicon.jpg" style="height:24px;"></td>
                                    <td>
                                        <a href="{{ val.location }}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">{{ val.location }}</a>
                                        <br><small style="color: var(--text-light);">Added {{ val.datetime}}</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <button type="button" onclick="handleResync('{{ val.location }}', event)" title="Resync">
                                            <img src="/static/refreshicon.png" alt="Resync">
                                        </button>
                                        <button type="button" onclick="openSchedule('{{ val.location }}')" title="Schedule">
                                            <img src="/static/timeicon.png" alt="Schedule">
                                        </button>
                                    </td>
                                    <td>
                                        {% set sched = schedule_dict.get(val.location) %}
                                        {% if sched %}
                                            {% if sched.time %}
                                                <small>{{sched.mode}} at {{ sched.time }}</small>
                                            {% elif sched.interval %}
                                                <small>Every {{ sched.interval }} min</small>
                                            {% endif %}
                                        {% else %}
                                            <small style="color: var(--text-light);">None</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="/remove_sharepoint">
                                            <input type="hidden" name="remove_bar" value="{{ val.location }}">
                                            <!--button type="submit" onclick="return confirm('Remove {{ val.location }}?')" class="btn-danger" style="padding: 4px 8px;">❌</button-->
                                            <button type="submit" onclick="return confirm('Remove {{ val.location }}?')" style="padding: 4px 8px;">❌</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 3: Debug Logs -->
                <div id="section3" class="section-content">
                    <div class="card">
                        <h2>Debug Logs</h2>
                        <div style="margin-bottom: 16px;">
                            <label style="font-weight: 500; margin-bottom: 8px; display: block;">Select Run Folder</label>
                            <select id="logRunSelect" style="width: 300px; padding: 8px; border-radius: 8px; border: 1px solid var(--border);"></select>
                        </div>
                        <pre id="logViewer" class="log-viewer"></pre>
                    </div>
                </div>

                <!-- Section 4: LLM Model -->
                <div id="section4" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User">
                        <span>{{username}}</span>
                    </div>

                    <div class="card">
                        <h2>
                            <img src="/static/llmicon.png" alt="LLM">
                            LLM Model Configuration
                        </h2>
                        <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>Currently using:</strong> {{llm_default}}
                        </div>
                        <form id="llmForm" class="left-form">
                            <div class="form-row">
                                <label>Select Model</label>
                                <select id="llmSelect" name="llm_model">
                                    <option value="Local" {% if llm_default == 'Local' %}selected{% endif %}>Local llama 3.2:1b</option>
                                    <option value="OpenAI" {% if llm_default == 'OpenAI' %}selected{% endif %}>OpenAI gpt-4o-mini</option>
                                </select>
                            </div>
                            <div class="form-row" id="openaiTokenField" style="display: none;">
                                <label>OpenAI API Key</label>
                                <input type="text" name="openai_token" value="{{ foo_values.get('openai_token', '') }}" placeholder="sk-...">
                            </div>
                            <button type="submit">
                                <!--img src="/static/saveicontransparent.png" alt=""-->
                                Save Model
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Section 5: Local Files -->
                <div id="section5" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User">
                        <div>
                            <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">{{username}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">JIRA: {{ foo_values.get('jira_url', 'Not configured')}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">LLM: {{llm_default}}</div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>
                            <img src="/static/localfiles.png" style="width: 30px; height: 24px;" alt="Local">
                            Share new local file with Agent
                        </h2>
                        <form method="POST" class="left-form" action="/add_local">
                            <div class="form-row">
                                <label>File Path</label>
                                <input type="text" name="local_value" id="local_value" placeholder="C:\path\to\file.xlsx">
                            </div>
                            <button type="submit" name="add_local">
                                <!--img src="/static/shareicon.png" alt=""-->
                                Share
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Local files shared with Agent</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="width: 40px;"></th>
                                    <th>File Path</th>
                                    <th style="width: 100px; text-align: center;">Actions</th>
                                    <th style="width: 180px;">Schedule</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for val in shared_files_local %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><img src="/static/excelicon.jpg" style="height:24px;"></td>
                                    <td>
                                        <span style="font-weight: 500;">{{ val.location }}</span>
                                        <br><small style="color: var(--text-light);">Added {{ val.datetime}}</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <button type="button" onclick="handleResync('{{ val.location }}', event)" title="Resync">
                                            <img src="/static/refreshicon.png" alt="Resync">
                                        </button>
                                        <button type="button" onclick="openSchedule('{{ val.location }}')" title="Schedule">
                                            <img src="/static/timeicon.png" alt="Schedule">
                                        </button>
                                    </td>
                                    <td>
                                        {% set sched = schedule_dict.get(val.location) %}
                                        {% if sched %}
                                            {% if sched.time %}
                                                <small>{{sched.mode}} at {{ sched.time }}</small>
                                            {% elif sched.interval %}
                                                <small>Every {{ sched.interval }} min</small>
                                            {% endif %}
                                        {% else %}
                                            <small style="color: var(--text-light);">None</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="/remove_local">
                                            <input type="hidden" name="remove_local" value="{{ val.location }}">
                                            <button type="submit" onclick="return confirm('Remove {{ val.location }}?')"  style="padding: 4px 8px;">❌</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 6: Google Drive -->
                <div id="section6" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User">
                        <div>
                            <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">{{username}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">JIRA: {{ foo_values.get('jira_url', 'Not configured')}}</div>
                            <div style="font-size: 14px; color: var(--text-light);">LLM: {{llm_default}}</div>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 12px; align-items: center;">
                            <span class="auth-status {% if google_logged_in %}authorized{% else %}unauthorized{% endif %}" style="font-size: 16px;">
                                {% if google_logged_in %}
                                    ✅ Google Drive: {{google_username}}
                                {% else %}
                                    🔒 Google Login Required
                                {% endif %}
                            </span>
                            {% if google_logged_in %}
                                <form method="GET" action="/google/logout" style="margin: 0;">
                                    <button type="submit" class="btn-danger" style="padding: 6px 12px; font-size: 13px;">Revoke</button>
                                </form>
                            {% else %}
                                <button type="button" onclick="openGoogleLoginPopup(this)" style="padding: 6px 12px; font-size: 13px;">Login</button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card">
                        <h2>
                            <img src="/static/googlesheetsicon.png" alt="Google Sheets">
                            Share new Google Sheet with Agent
                        </h2>
                        <form method="POST" class="left-form" action="/add_google">
                            <div class="form-row">
                                <label>Google Sheet URL</label>
                                <input type="text" name="google_value" id="google_value" placeholder="https://docs.google.com/spreadsheets/d/...">
                            </div>
                            <button type="submit" name="add_google">
                                <!--img src="/static/shareicon.png" alt=""-->
                                Share
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2>Google Sheets shared with Agent</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="width: 40px;"></th>
                                    <th>Sheet URL</th>
                                    <th style="width: 100px; text-align: center;">Actions</th>
                                    <th style="width: 180px;">Schedule</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for val in shared_files_google %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td><img src="/static/googlesheetfileicon.png" style="height:24px;"></td>
                                    <td>
                                        <a href="{{ val.location }}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 500;">{{ val.location }}</a>
                                        <br><small style="color: var(--text-light);">Added {{ val.datetime}}</small>
                                    </td>
                                    <td style="text-align: center;">
                                        <button type="button" onclick="handleResync('{{ val.location }}', event)" title="Resync">
                                            <img src="/static/refreshicon.png" alt="Resync">
                                        </button>
                                        <button type="button" onclick="openSchedule('{{ val.location }}')" title="Schedule">
                                            <img src="/static/timeicon.png" alt="Schedule">
                                        </button>
                                    </td>
                                    <td>
                                        {% set sched = schedule_dict.get(val.location) %}
                                        {% if sched %}
                                            {% if sched.time %}
                                                <small>{{sched.mode}} at {{ sched.time }}</small>
                                            {% elif sched.interval %}
                                                <small>Every {{ sched.interval }} min</small>
                                            {% endif %}
                                        {% else %}
                                            <small style="color: var(--text-light);">None</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="/remove_google">
                                            <input type="hidden" name="remove_google" value="{{ val.location }}">
                                            <button type="submit" onclick="return confirm('Remove {{ val.location }}?')" style="padding: 4px 8px;">❌</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Section 7: Info -->
                <div id="section7" class="section-content">
                    <div class="user-header">
                        <img src="/static/usericon2.png" alt="User">
                        <span>{{username}}</span>
                    </div>
                    <div class="card">
                        <h2>System Information</h2>
                        <p style="color: var(--text-light);">Version and system details will appear here.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                <img src="/static/timeicon.png" style="height:32px;">
                Schedule File Sync
            </h2>

            <form id="scheduleForm" method="POST" action="/schedule">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 8px;">File</label>
                    <textarea id="scheduleFilename" name="filename" readonly 
                        style="width:100%; padding: 12px; border:1px solid var(--border); background-color:var(--bg-light); 
                        font-size:14px; border-radius: 8px; resize:none; height: 70px; font-family: inherit;"></textarea>
                </div>

                <div class="schedule-grid">
                    <div class="schedule-option">
                        <h4 style="margin-bottom: 12px; color: var(--text-dark);">⏰ Time-based Schedule</h4>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 6px; font-size: 14px;">Time (HH:MM)</label>
                            <input type="text" id="scheduleTime" name="time" placeholder="14:30"
                                style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                        </div>
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                <input type="radio" class="scheduleMode" name="mode" value="Daily">
                                <span style="font-weight: 500;">Daily</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" class="scheduleMode" name="mode" value="Weekly">
                                <span style="font-weight: 500;">Weekly</span>
                            </label>
                        </div>
                        <div id="weeklyDays" style="display: none; margin-top: 12px;">
                            <label><input type="checkbox" name="days" value="mon"> Mon</label>
                            <label><input type="checkbox" name="days" value="tue"> Tue</label>
                            <label><input type="checkbox" name="days" value="wed"> Wed</label>
                            <label><input type="checkbox" name="days" value="thu"> Thu</label>
                            <label><input type="checkbox" name="days" value="fri"> Fri</label>
                            <label><input type="checkbox" name="days" value="sat"> Sat</label>
                            <label><input type="checkbox" name="days" value="sun"> Sun</label>
                        </div>
                    </div>

                    <div class="schedule-option">
                        <h4 style="margin-bottom: 12px; color: var(--text-dark);">🔄 Interval-based Schedule</h4>
                        <label style="display: block; margin-bottom: 6px; font-size: 14px;">Interval (minutes)</label>
                        <input type="number" id="scheduleInterval" name="interval" min="1" placeholder="30"
                            style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            Runs automatically every X minutes
                        </p>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" id="scheduleSubmit">
                        <!--img src="/static/saveicontransparent.png" alt=""-->
                        Save Schedule
                    </button>
                    <button type="button" id="clearScheduleBtn" class="btn-danger">
                        Clear Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script>
        /* Section Management */
        const sections = {
            section1: document.getElementById('section1'),
            section2: document.getElementById('section2'),
            section3: document.getElementById('section3'),
            section4: document.getElementById('section4'),
            section5: document.getElementById('section5'),
            section6: document.getElementById('section6'),
            section7: document.getElementById('section7')
        };

        const buttons = {
            section1: document.getElementById('btn-section1'),
            section2: document.getElementById('btn-section2'),
            section3: document.getElementById('btn-section3'),
            section4: document.getElementById('btn-section4'),
            section5: document.getElementById('btn-section5'),
            section6: document.getElementById('btn-section6'),
            section7: document.getElementById('btn-section7')
        };

        function showSection(sectionId) {
            Object.keys(sections).forEach(key => {
                sections[key].classList.remove('active');
                if (buttons[key]) buttons[key].classList.remove('active');
            });
            if (sections[sectionId]) {
                sections[sectionId].classList.add('active');
                if (buttons[sectionId]) buttons[sectionId].classList.add('active');
                history.replaceState(null, '', '#' + sectionId);
            }
        }

        Object.keys(buttons).forEach(key => {
            const btn = buttons[key];
            if (btn) btn.addEventListener('click', () => showSection(key));
        });

        window.addEventListener("DOMContentLoaded", () => {
            fetch('/getmodel')
            .then(res => res.json())
            .then(data => {
                if (data.default_model) {
                    const s = document.getElementById('llmSelect');
                    if (s) s.value = data.default_model;
                }
            })
            .catch(err => console.error('Failed to fetch default model:', err));

            const hash = window.location.hash.substring(1);
            if (hash && sections[hash]) {
                showSection(hash);
            } else {
                showSection('section2');
            }
        });

        /* Login Popups */
        let lastLoginBtn = null;
        function openLoginPopup(btn) {
            lastLoginBtn = btn;
            const popup = window.open("/login", "LoginWindow", "width=600,height=700");
            if (!popup) alert("Please allow popups for this site.");
        }

        window.addEventListener("message", function(e) {
            if (e.data === "login-success" && lastLoginBtn) {
                location.reload();
            }
        });

        let lastGoogleLoginBtn = null;
        function openGoogleLoginPopup(btn) {
            lastGoogleLoginBtn = btn;
            const popup = window.open("/google/login", "GoogleLoginWindow", "width=600,height=700");
            if (!popup) alert("Please allow popups for this site.");
        }

        window.addEventListener("message", function(e) {
            if (e.data === "google-login-success" && lastGoogleLoginBtn) {
                location.reload();
            }
        });

        /* Schedule Modal */
        const scheduleTime = document.getElementById("scheduleTime");
        const scheduleInterval = document.getElementById("scheduleInterval");
        const modeCheckboxes = document.querySelectorAll(".scheduleMode");

        function enforceMutualExclusivity() {
            const timeVal = scheduleTime.value.trim();
            const intervalVal = scheduleInterval.value.trim();

            scheduleTime.disabled = !!intervalVal;
            scheduleInterval.disabled = !!timeVal;
            modeCheckboxes.forEach(cb => cb.disabled = !!intervalVal);
            document.getElementById("scheduleSubmit").disabled = !(timeVal || intervalVal);
        }

        if (scheduleTime) scheduleTime.addEventListener("input", enforceMutualExclusivity);
        if (scheduleInterval) scheduleInterval.addEventListener("input", enforceMutualExclusivity);

        function openSchedule(filename) {
            const sched = scheduleData[filename];

            document.getElementById("scheduleFilename").value = filename;
            document.getElementById("scheduleTime").value = sched && sched.time ? sched.time : "";
            document.getElementById("scheduleInterval").value = sched && sched.interval ? sched.interval : "";

            document.querySelectorAll("input[name='mode']").forEach(r => r.checked = false);

            if (sched && sched.mode) {
                const el = document.querySelector(`input[name='mode'][value='${sched.mode}']`);
                if (el) el.checked = true;

                if (sched.mode.toLowerCase() === "weekly") {
                    document.getElementById("weeklyDays").style.display = "grid";
                } else {
                    document.getElementById("weeklyDays").style.display = "none";
                }
            } else {
                document.getElementById("weeklyDays").style.display = "none";
            }

            document.querySelectorAll("#weeklyDays input[type=checkbox]").forEach(cb => cb.checked = false);
            if (sched && sched.days) {
                sched.days.forEach(day => {
                    const cb = document.querySelector(`#weeklyDays input[value='${day}']`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById("scheduleModal").style.display = "block";
            enforceMutualExclusivity();
        }

        document.querySelector(".close").onclick = function() {
            document.getElementById("scheduleModal").style.display = "none";
        };

        window.onclick = function(event) {
            if (event.target === document.getElementById("scheduleModal")) {
                document.getElementById("scheduleModal").style.display = "none";
            }
        };

        function showToast(message, success=true) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.style.backgroundColor = success ? "var(--success)" : "var(--danger)";
            toast.className = "show";
            setTimeout(() => { toast.className = ""; }, 3000);
        }

        document.getElementById("scheduleForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const time = scheduleTime.value.trim();
            const interval = scheduleInterval.value.trim();
            if (!time && !interval) { showToast("⚠ Enter time or interval", false); return; }

            const formData = new FormData(this);
            let selectedMode = "";
            document.querySelectorAll("input[name='mode']").forEach(r => { if (r.checked) selectedMode = r.value; });
            formData.append("mode", selectedMode);

            fetch(this.action, { method: "POST", body: formData })
            .then(response => {
                if (response.ok) {
                    showToast("✅ Schedule saved successfully");
                    document.getElementById("scheduleModal").style.display = "none";
                    setTimeout(() => location.reload(), 800);
                } else {
                    showToast("⚠ Failed to save schedule", false);
                }
            })
            .catch(() => showToast("⚠ Error connecting to server", false));
        });

        const clearScheduleBtn = document.getElementById("clearScheduleBtn");
        clearScheduleBtn.addEventListener("click", function() {
            const filename = document.getElementById("scheduleFilename").value;
            if (!filename) return;
           /* if (!confirm(`Clear schedule for ${filename}?`)) return;*/

            fetch('/schedule/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast("✅ Schedule cleared");
                    document.getElementById("scheduleModal").style.display = "none";
                    setTimeout(() => location.reload(), 800);
                } else {
                    showToast("⚠ Failed to clear schedule", false);
                }
            })
            .catch(() => showToast("⚠ Error connecting to server", false));
        });

        modeCheckboxes.forEach(cb => {
            cb.addEventListener("change", function() {
                if (this.checked) {
                    modeCheckboxes.forEach(other => {
                        if (other !== this) other.checked = false;
                    });
                }
            });
        });

        flatpickr("#scheduleTime", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true
        });

        document.querySelectorAll("input[name='mode']").forEach(radio => {
            radio.addEventListener("change", function() {
                const weeklyDaysDiv = document.getElementById("weeklyDays");
                if (this.value.toLowerCase() === "weekly") {
                    weeklyDaysDiv.style.display = "grid";
                } else {
                    weeklyDaysDiv.style.display = "none";
                }
            });
        });

        const scheduleData = {{ schedule_dict | tojson | safe }} || {};

        /* LLM Form */
        const llmSelect = document.getElementById('llmSelect');
        const openaiTokenField = document.getElementById('openaiTokenField');
        
        function toggleTokenField() {
            if (!llmSelect) return;
            if (llmSelect.value === 'OpenAI') {
                openaiTokenField.style.display = 'flex';
            } else {
                openaiTokenField.style.display = 'none';
            }
        }
        
        if (llmSelect) {
            toggleTokenField();
            llmSelect.addEventListener('change', toggleTokenField);
        }

        const llmForm = document.getElementById('llmForm');
        if (llmForm) {
            llmForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const selectedModel = document.getElementById('llmSelect').value;
                const openaiToken = document.querySelector('input[name="openai_token"]') ? document.querySelector('input[name="openai_token"]').value : '';

                fetch('/setmodel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        llm_model: selectedModel,
                        openai_token: openaiToken
                    })
                })
                .then(res => {
                    if (res.ok) {
                        showToast(`✅ Saved LLM model: ${selectedModel}`);
                        setTimeout(() => { window.location.hash = "section4"; window.location.reload(); }, 900);
                    } else {
                        showToast('⚠ Failed to save settings', false);
                    }
                })
                .catch(() => showToast('⚠ Error connecting to server', false));
            });
        }

        /* Jira Form */
        const jiraForm = document.querySelector('#section1 form.left-form');
        if (jiraForm) {
            jiraForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = {
                    jira_url: this.querySelector('input[name="jira_url"]').value,
                    jira_user: this.querySelector('input[name="jira_user"]').value,
                    jira_token: this.querySelector('input[name="jira_token"]').value,
                    jira_password: this.querySelector('input[name="jira_password"]').value
                };
                fetch('/save_jira', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) showToast('✅ Jira settings saved');
                    else showToast('⚠ Failed to save Jira settings', false);
                })
                .catch(() => showToast('⚠ Error connecting to server', false));
            });
        }

        /* AJAX Form Submissions */
        const addSharepointForm = document.querySelector('form[action="/add_sharepoint"]');
        if (addSharepointForm) {
            addSharepointForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section2"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        }

        document.querySelectorAll('form[action="/remove_sharepoint"]').forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section2"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        });

        const localForm = document.querySelector('form[action="/add_local"]');
        if (localForm) {
            localForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section5"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        }

        document.querySelectorAll('form[action="/remove_local"]').forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section5"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        });

        const addGoogleForm = document.querySelector('form[action="/add_google"]');
        if (addGoogleForm) {
            addGoogleForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section6"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        }

        document.querySelectorAll('form[action="/remove_google"]').forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section6"; window.location.reload(); }, 900);
                    } else {
                        showToast(`⚠ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("⚠ Error connecting to server", false));
            });
        });

        /* Task Queue Management */
        const activeTasks = new Map();
        let globalPollInterval = null;

        function formatTime(dateString) {
            if (!dateString) return '--:--:--';
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        function getShortFilename(url) {
            const parts = url.split('/');
            return parts[parts.length - 1] || url.substring(0, 50);
        }

        function updateTaskDisplay() {
            const taskQueueDiv = document.getElementById('taskQueueStatus');
            const taskListDiv = document.getElementById('taskList');
            
            if (activeTasks.size === 0) {
                taskQueueDiv.style.display = 'none';
                return;
            }
            
            taskQueueDiv.style.display = 'block';
            
            let html = '';
            activeTasks.forEach((task, taskId) => {
                const shortFilename = getShortFilename(task.fileUrl);
                const statusClass = task.status.toLowerCase();
                const statusIcon = {
                    'pending': '⏳',
                    'running': '🔄',
                    'completed': '✅',
                    'failed': '❌'
                }[task.status.toLowerCase()] || '•';
                
                html += `
                    <div class="task-item ${statusClass}" data-task-id="${taskId}">
                        <div class="task-info">
                            <div class="task-filename">${statusIcon} ${shortFilename}</div>
                            <div class="task-times">
                                Created: ${formatTime(task.created_at)} | 
                                Started: ${formatTime(task.started_at)} | 
                                Completed: ${formatTime(task.completed_at)}
                            </div>
                            ${task.error ? `<div style="color: var(--danger); font-size: 11px; margin-top: 4px;">Error: ${task.error}</div>` : ''}
                        </div>
                        <span class="task-status-badge status-${statusClass}">${task.status}</span>
                    </div>
                `;
            });
            
            taskListDiv.innerHTML = html;
        }

        function removeCompletedTask(taskId) {
            const task = activeTasks.get(taskId);
            if (task && (task.status === 'completed' || task.status === 'failed')) {
                activeTasks.delete(taskId);
                updateTaskDisplay();
                console.log(`[Task] Removed completed task ${taskId.substring(0, 8)}`);
            }
        }

        function clearAllTasks() {
           /* if (!confirm('Clear ALL tasks from the list? Running tasks will continue in the background.')) {
                return;
            }*/
            
            const count = activeTasks.size;
            activeTasks.clear();
            updateTaskDisplay();
            console.log(`[Task] Cleared all ${count} tasks from display`);
        }

        async function pollAllTasks() {
            try {
                const response = await fetch('/tasks/status');
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Failed to fetch task status');
                    return;
                }
                
                data.tasks.forEach(task => {
                    const taskId = task.task_id;
                    
                    if (activeTasks.has(taskId)) {
                        const localTask = activeTasks.get(taskId);
                        localTask.status = task.status;
                        localTask.started_at = task.started_at;
                        localTask.completed_at = task.completed_at;
                        localTask.progress = task.progress;
                        localTask.error = task.error;
                        
                        if ((task.status === 'completed' || task.status === 'failed') && !localTask.removeScheduled) {
                            localTask.removeScheduled = true;
                            setTimeout(() => removeCompletedTask(taskId), 60000);
                        }
                    }
                });
                
                updateTaskDisplay();
                
            } catch (error) {
                console.error('Error polling tasks:', error);
            }
        }

        function startGlobalPolling() {
            if (globalPollInterval) return;
            
            globalPollInterval = setInterval(() => {
                if (activeTasks.size > 0) {
                    pollAllTasks();
                } else {
                    clearInterval(globalPollInterval);
                    globalPollInterval = null;
                }
            }, 3000);
        }

        async function handleResync(fileUrl, event) {
            if (event) event.preventDefault();
            /*
            if (!confirm(`Start resync for ${fileUrl}?`)) {
                return;
            }*/
            
            try {
                const formData = new FormData();
                formData.append('resync_bar', fileUrl);
                
                const response = await fetch('/resync_sharepoint', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    showToast('Failed to start resync: ' + data.message, false);
                    return;
                }
                
                const taskId = data.task_id;
                
                activeTasks.set(taskId, {
                    taskId: taskId,
                    fileUrl: fileUrl,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    started_at: null,
                    completed_at: null,
                    progress: 0,
                    error: null,
                    removeScheduled: false
                });
                
                updateTaskDisplay();
                startGlobalPolling();
                
                showToast(`✅ Resync queued for ${getShortFilename(fileUrl)}`);
                
            } catch (error) {
                console.error('Resync error:', error);
                showToast('Error starting resync: ' + error.message, false);
            }
        }

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('activeTasks', JSON.stringify([...activeTasks]));
        });

        window.addEventListener('DOMContentLoaded', () => {
            const saved = JSON.parse(localStorage.getItem('activeTasks') || '[]');
            saved.forEach(([id, task]) => activeTasks.set(id, task));
            updateTaskDisplay();
            startGlobalPolling();
        });

        /* Debug Logs Viewer */
        async function loadRunFolders() {
            try {
                const res = await fetch("/logs");
                const runs = await res.json();
                const select = document.getElementById("logRunSelect");
                select.innerHTML = "";
                runs.forEach(run => {
                    const opt = document.createElement("option");
                    opt.value = run;
                    opt.textContent = run;
                    select.appendChild(opt);
                });
                if (runs.length) {
                    select.value = runs[0];
                    loadLogFile(runs[0]);
                } else {
                    document.getElementById("logViewer").textContent = "No logs found.";
                }
            } catch (err) {
                document.getElementById("logViewer").textContent = "⚠ Error loading log folders.";
                console.error(err);
            }
        }

        async function loadLogFile(run) {
            try {
                const res = await fetch(`/logs/${run}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                const viewer = document.getElementById("logViewer");
                
                if (!text.trim()) {
                    viewer.textContent = "(empty)";
                } else {
                    let formatted = text;

                    formatted = formatted
                        .replace(/(ERROR)/g, '<span class="log-error">$1</span>')
                        .replace(/(WARNING)/g, '<span class="log-warning">$1</span>')
                        .replace(/(--- Running.*?---)/g, '<span class="log-info">$1</span>')
                        .replace(/(INFO)/g, '<span class="log-info">$1</span>');

                    formatted = formatted.replace(
                        /(Traceback \(most recent call last\):[\s\S]*?(?=\n\s*\n|$))/g,
                        '<span class="traceback-block">$1</span>'
                    );

                    viewer.innerHTML = formatted;
                }
                
                viewer.scrollTop = viewer.scrollHeight;
            } catch (err) {
                document.getElementById("logViewer").textContent = "⚠ Failed to load log file.";
                console.error(err);
            }
        }

        const logRunSelect = document.getElementById("logRunSelect");
        if (logRunSelect) {
            logRunSelect.addEventListener("change", e => loadLogFile(e.target.value));
        }

        window.addEventListener("DOMContentLoaded", () => {
            if (document.getElementById("section3")) loadRunFolders();
        });
    </script>
</body>
</html>