<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Config Form - Two Column</title>
    <style>
        /* ----- Layout: two columns ----- */
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            color: #414040;
        }
        .app-container {
            display: flex;
            height: 100vh; /* full viewport */
            overflow: hidden;
        }

        /* Left frame (menu) */
       .left-frame {
            flex: 0 0 220px;
            background-color: rgb(12, 67, 122);
            display: flex;
            flex-direction: column;
            padding: 0;       /* remove padding so image is flush */
            box-sizing: border-box;
            gap: 8px;
            color: white;
            overflow-y: auto;
        }

        /* Right frame (content) */
        .right-frame {
            flex: 1 1 auto;
            background: #f6f7f9;
            overflow: auto;
        }

        /* keep existing banner behaviour but reduced height to fit */
        img.banner { width: 100%; max-height: 240px; object-fit: cover; display: block; }

       .menu-bar {
            display: flex;
            flex-direction: column;
            padding: 0;       /* remove menu-bar padding */
            margin: 0;
            gap: 0px;
        }

        .menu-bar img.sidebar-logo {
            display: block;
            width: 100%;
            margin: 0;
            padding: 0;
            border: none;
        }

        .menu-bar button {
            flex: 1;
            padding: 10px;
            border: none;
            background-color: rgb(12, 67, 122);
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: left;
            gap: 8px;
            border-radius: 0px;
        }

        .menu-bar button img {
            height: 28px;
            width: 28px;
            object-fit: contain;
        }

        .menu-bar button span { color: white; font-size: 15px; font-weight: normal; }

        .menu-bar button:hover { background-color: rgba(255,255,255,0.08); }

        .menu-bar button.active { background-color: rgba(255,255,255,0.14); }
/*
        .action-btn img {
            width: 16px;    
            height: 16px;
            background-color: #999c9e;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
*/
        .action-btn:hover {
        background-color: #0055aa;
        }

        /* Put logout visually separated at bottom (if you want that) */
        .left-footer {
            margin-top: auto;
            display: flex;
            gap: 8px;
        }

        /* page content (right) - keep your original styles mostly */
        .page-content {
            padding: 30px 60px 18px 50px; /* top right bottom left */   
            box-sizing: border-box;
            min-height: 100%;
        }

        h3 { margin-bottom: 4px; }
        ol { margin-top: 4px; }
        .sync-desc { margin: 0 0 4px 0; }

        form label { display: inline-block; width: 150px; vertical-align: middle; }
        form input[type="text"] { display: inline-block; vertical-align: middle; width: 300px; margin-bottom: 10px; }
        form button { margin-top: 10px; }

        .section-content { display: none; padding: 12px 0; }
        .section-content.active { display: block; }

        .left-form {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            margin: 0;
            width: 100%;
            max-width: 520px;
        }
        .left-form label { display: block; font-weight: normal; width: 300px; }
        .left-form input, .left-form button, .left-form select { width: 100%; box-sizing: border-box; }

/*        .table-btn {
            border: 1px solid #ccc;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .table-btn:hover { background-color: #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .table-btn img { height: 20px; vertical-align: middle; }
*/
        /* === Modal === */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        
        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 20px 30px;
            width: 300px;
            max-width: 90%;
            border-radius: 0px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            color: #414040;
        }

        .close { float: right; font-size: 22px; font-weight: bold; cursor: pointer; color: #888; }
        .close:hover { color: #000; }

        #scheduleForm label { display: block; font-weight: normal; margin-top: 10px; margin-bottom: 4px; }
        #scheduleForm input, #scheduleForm textarea {
            padding: 6px; margin-bottom: 8px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; box-sizing: border-box;
        }

        /* Toast styling */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 14px;
            position: fixed;
            z-index: 1000;
            right: 20px; top: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.5s, top 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; top: 40px; }

        /* smaller tweaks */
        h2 { display:flex; align-items:center; gap:10px; margin:0 0 10px 0; }
        h2 img { width:40px; height:auto; }
        @media (max-width: 800px) {
            .left-frame { flex: 0 0 64px; } /* collapse sidebar on small screens if desired */
            .menu-bar button span { display:none; } /* show icons only */
            img.banner { max-height:120px; }
        }

        .spinner {
            margin: 20px auto;
            width: 40px;
            height: 40px;
            background: linear-gradient(90deg, #4caf50, #2196f3);
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); opacity: 0.7; }
            to   { transform: scale(1.2); opacity: 1; }
        }


        /* Reset right-frame buttons to plain defaults */
        .right-frame button img {
            width: 20px;        /* adjust to whatever size fits */
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 1px;  /* space between icon and text */
        }

        .right-frame button:hover {
            background: #e0e0e0;
        }

        .right-frame button {
            all: unset;
            display: inline-flex;     /* instead of inline-block */
            align-items: center;      /* vertically centers icon + text */
            gap: 4px;                 /* space between icon and text */
            padding: 2px 6px;
            border: 1px solid #ccc;    /* light grey border */
            background: ButtonFace;
            color: ButtonText;
            font: inherit;
            cursor: pointer;
            line-height: 1.2;         /* keep text aligned */
        }

        .right-frame button img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .menu-divider {
            height: 1px;              /* thickness */
            background-color: rgba(255, 255, 255, 0.3);  /* light gray / translucent */
            margin: 8px 0;            /* spacing above and below */
            width: 100%;              /* span full menu width */
        }


    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body>


    <!-- Loading Modal -->
    <div id="loadingModal" class="modal">
    <div class="modal-content" style="text-align:center;">
        <!--img src="/static/sync-icon.png" alt="Scan"-->
        <h3> Data scan in progress...</h3>
        <div class="spinner"></div>
    </div>
    </div>


    <div class="app-container">
        <!-- LEFT: vertical menu -->
        <aside class="left-frame">
        <div class="menu-bar" role="navigation" aria-label="Main menu" style="padding:0; margin:0;">
            <img src="/static/banner3.jpg" alt="Logo" 
                style="width:100%; display:block; margin:0; padding:0; border:none;">
        
            <!-- Menu buttons -->
            <button id="btn-section1"><img src="/static/jiraicon.png" alt="Jira Icon"><span>Jira</span></button>
            <button id="btn-section4"><img src="/static/llmicon.png" alt="LLM Icon"><span>LLM Model</span></button>
            <div class="menu-divider"></div>
            <button id="btn-section5"><img src="/static/localfiles.png" alt="Local Files Icon" style="width:25px; height:22px"><span>Local Files</span></button>
            <button id="btn-section2"><img src="/static/sharepointicontransparent.png" alt="SharePoint Icon" style="width:30px; height:30px"><span>SharePoint</span></button>
            <button id="btn-section6"><img src="/static/googlesheetsicon.png" alt="GoogleSheets"><span>Google Drive</span></button>
            <!-- Divider -->
            <div class="menu-divider"></div>
            <button id="btn-section7"><img src="/static/versioninfoicon.png" alt="Info" text-align:left; vertical-align:middle; style="width:28px; height:28px"><span>Info</span></button>
            <button id="btn-section3"><img src="/static/debuglogs.png" alt="Debug Logs"><span>Debug Logs</span></button>
        </div>

            <!-- keep logout pinned to bottom of sidebar -->
            <div class="menu-bar" role="navigation" aria-label="Main menu">
                <button id="btn-exit" onclick="window.location.href='/logout'"><img src="/static/exiticon.png" alt="Exit Icon" vertical-align:middle; style="width:25px; height:25px;"><span>Logout</span></button>
            </div>
        </aside>

        <!-- RIGHT: banner + content -->
        <main class="right-frame">
            <!--img src="{{ banner_path }}" alt="Banner" class="banner"-->

            <div class="page-content">
                <!-- Section 1: Jira -->
                <div id="section1" class="section-content">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <img src="/static/usericon.png" alt="Login" style="width:25px; height:25px">
                        <span>{{username}}</span>
                    </div>                    
                    <br><br>
                    <h2><img src="/static/jiraicon.jpg" alt="Jira" style="height:32px; vertical-align:bottom; margin-right:2px;">Jira Connection Info</h2>
                    <form method="POST" class="left-form">
                        <label>Jira Cloud URL:</label>
                        <input type="text" name="jira_url" value="{{ foo_values.get('jira_url', '') }}">
                        <label>Jira Email:</label>
                        <input type="text" name="jira_user" value="{{ foo_values.get('jira_user', '') }}">
                        <label>Jira API Token:</label>
                        <input type="text" name="jira_token" value="{{ foo_values.get('jira_token', '') }}">
                        <button type="submit" name="save_foo"><img src="/static/saveicontransparent.png" style="height:20px; vertical-align:middle; margin-right:6px;">Save</button>
                    </form>
                </div>

                                <!-- Section 7: VersionInfo -->
                <div id="section7" class="section-content">
        
                </div>

                                <!-- Section 6: Googlesheets -->
                <div id="section6" class="section-content">
        
                </div>

                <!-- Section 2: Sharepoint -->
                <div id="section2" class="section-content">
                    <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                        <!-- Left side: user icon + name -->
                        <div style="display:flex; align-items:center; gap:6px;">
                            <img src="/static/usericon.png" alt="Login" style="width:30px; height:25px">
                            <span>{{username}}</span>
                        </div>

                        <!-- Right side: permissions -->
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span>SharePoint site permissions:</span>
                            {% if logged_in %}
                                <button type="button" title="Logged in">✅ Authorized</button>
                            {% else %}
                                <button type="button" class="login-btn" onclick="openLoginPopup(this)" title="Login">🔐 Login Required</button>
                            {% endif %}
                        </div>
                    </div>
                    <br>
                    <h2><img src="/static/sharepointicontransparent.png" style="width:48px; height:48px; vertical-align:bottom; margin-right:2px;">Connect SharePoint File to AI Agent</h2>
                    <form method="POST" class="left-form" action="/add_sharepoint">
                        <label for="bar_value">Direct Download URL to SharePoint File:</label>
                        <input type="text" name="bar_value" id="bar_value" placeholder="https://...">
                        <button type="submit" name="add_bar"><img src="/static/llmicon.png" style="height:20px; vertical-align:middle; margin-right:6px;">Connect</button>
                    </form>
                    <br><br><br><br>
                    <h2>Active Sharepoint Connections</h2>
                    <table style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr>
                            <th style="text-align:center; padding:6px; font-size:16px;"> </th>
                            <th style="text-align:center; padding:6px; font-size:16px;"> </th>
                            <th style="text-align:left; padding:6px; font-size:16px;">Connected Files</th>
                            <th style="text-align:center; padding:1px; font-size:10px;">Repeat</th>
                            <th style="text-align:center; padding:1px; font-size:10px;">Schedule</th>
                            <th style="text-align:center; padding:1px; font-size:10px;">Run</th>
                            <th style="text-align:center; padding:1px; font-size:10px;">Remove</th>                            </tr>
                        </thead>
                        <tbody>
                            {% for val in bar_values %}
                            <tr>
                                <td style="text-align:left; padding:6px;">{{ loop.index }}</td>
                                <td style="text-align:left; padding:6px;">                                    
                                    <img src="/static/excelicon.jpg" style="height:18px; vertical-align:bottom; margin-right:2px;">
                                </td>
                                <td style="padding:6px;">
                                    <a href="{{ val }}" target="_blank">{{ val }}</a></td>
                                <td style="text-align:center; padding:1px;">
                                    {% set sched = schedule_dict.get(val) %}
                                    {% if sched %}
                                        {% if sched.time %}
                                            <span style="font-size:12px; margin-left:6px;">{{sched.mode}} at {{ sched.time }}</span>
                                        {% elif sched.interval %}
                                            <span style="font-size:12px; margin-left:6px;">Every {{ sched.interval }} min</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="font-size:12px; margin-left:6px;">None</span>
                                    {% endif %}
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <button type="button"  onclick="openSchedule('{{ val }}')">
                                        <img src="/static/schedule-icon.png" alt="Schedule">
                                    </button>
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <form method="POST">
                                        <input type="hidden" name="resync_bar" value="{{ val }}">
                                        <button type="submit"  name="resync_bar" onclick="return confirm('Resync {{ val }}?')"><img src="/static/sync-icon.png" alt="Resync"></button>
                                    </form>
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <form method="POST" action="/remove_sharepoint">
                                        <input type="hidden" name="remove_bar" value="{{ val }}">
                                        <button type="submit"  onclick="return confirm('Remove {{ val }}?')"><img src="/static/delete-icon.png" alt="Delete" style="width:21px; height:21px"></button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Section 5: Local Files -->
                <div id="section5" class="section-content">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <img src="/static/usericon.png" alt="Login" style="width:30px; height:25px;">
                        <span>{{username}}</span>
                        </div>
                    <br>
                    <h2><img src="/static/localfiles.png" style="width:45px; height:35px; vertical-align:bottom; margin-right:2px;">Connect Local Disk File to AI Agent</h2>
                    <form method="POST" class="left-form" action="/add_local">
                        <label for="local_value">Full File Path with Drive Letter:</label>
                        <input type="text" name="local_value" id="local_value" placeholder="/path/to/file.xlsx">
                        <button type="submit" name="add_local">
                            <img src="/static/llmicon.png" style="height:25x; vertical-align:middle; margin-right:6px;">Connect
                        </button>
                    </form>

                    <br><br><br><br>
                    <h2>Active Local File Connections</h2>

                    <table style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr>
                                <th style="text-align:center; padding:6px; font-size:16px;"> </th>
                                <th style="text-align:center; padding:6px; font-size:16px;"> </th>
                                <th style="text-align:left; padding:6px; font-size:16px;">Connected Files</th>
                                <th style="text-align:center; padding:1px; font-size:10px;">Repeat</th>
                                <th style="text-align:center; padding:1px; font-size:10px;">Schedule</th>
                                <th style="text-align:center; padding:1px; font-size:10px;">Run</th>
                                <th style="text-align:center; padding:1px; font-size:10px;">Remove</th>                            </tr>
                            </tr>
                        </thead>
                        <tbody>
                            {% for val in local_values %}
                            <tr>
                                <td style="text-align:center; padding:6px;">{{ loop.index }}</td>
                                <td style="text-align:left; padding:6px;">                                    
                                    <img src="/static/excelicon.jpg" style="height:18px; vertical-align:bottom; margin-right:2px;">
                                </td>
                                <td style="padding:6px;">
                                    <span>{{ val }}</span>
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    {% set sched = schedule_dict.get(val) %}
                                    {% if sched %}
                                        {% if sched.time %}
                                            <span style="font-size:12px; margin-left:6px;">{{sched.mode}} at {{ sched.time }}</span>
                                        {% elif sched.interval %}
                                            <span style="font-size:12px; margin-left:6px;">Every {{ sched.interval }} min</span>
                                        {% endif %}
                                    {% else %}
                                        <span style="font-size:12px; margin-left:6px;">None</span>
                                    {% endif %}
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <button type="button" class="table-btn" onclick="openSchedule('{{ val }}')">
                                        <img src="/static/schedule-icon.png" alt="Schedule">
                                    </button>
                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <form method="POST">
                                        <input type="hidden" name="resync_bar" value="{{ val }}">
                                        <button type="submit" name="resync_bar" class="table-btn" onclick="return confirm('Resync {{ val }}?')">
                                            <img src="/static/sync-icon.png" alt="Resync">
                                        </button>
                                    </form>

                                </td>
                                <td style="text-align:center; padding:1px;">
                                    <form method="POST"  action="/remove_local">
                                        <button type="submit" class="table-btn" onclick="return confirm('Remove {{ val }}?')">
                                            <img src="/static/delete-icon.png" alt="Delete">
                                        </button>
                                        <input type="hidden" name="remove_local" value="{{ val }}">
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Section 3: Logs -->
                <div id="section3" class="section-content">
                    <h3>Debug Logs</h3>
                    <ul>
                    {% for file in folder_tree %}
                        <li>📄 {{ file.name }} — <small>{{ file.modified }}</small>
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="view_log" value="{{ file.name }}">
                                <button type="submit">👁️ View</button>
                            </form>
                        </li>
                    {% endfor %}
                    </ul>
                </div>

                <!-- Section 4: LLM Model -->
                <div id="section4" class="section-content">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <img src="/static/usericon.png" alt="Login" style="width:25px; height:25px">
                        <span>{{username}}</span>
                        </div>
                    <br>
                    <h2 style="display: flex; align-items: center; gap: 10px;">
                        <img src="/static/llmicon.png" alt="LLM Icon" style="width:60px;">
                        Change LLM Model
                    </h2>
                    <label>Currently using: {{llm_default}}</label>
                    <br><br>
                    <form id="llmForm" class="left-form">
                        <label for="llmSelect">Change to different model:</label>
                        <select id="llmSelect" name="llm_model"  style="width:300px; padding:6px;">
                            <option value="Local" {% if llm_default == 'Local' %}selected{% endif %}>Local llama 3.2:1b</option>
                            <option value="OpenAI" {% if llm_default == 'OpenAI' %}selected{% endif %}>OpenAI gpt-4o-mini</option>
                        </select>

                        <!-- OpenAI token field, hidden by default -->
                        <div id="openaiTokenField" style="display: none; margin-top: 10px;">
                            <label>OpenAI API Key:</label>
                            <input type="text" name="openai_token" value="{{ foo_values.get('openai_token', '') }}"  style="width:300px; padding:6px;">
                        </div>

                        <button type="submit" class="table-btn" style="width:100px; margin-top:10px;">
                            <img src="/static/saveicontransparent.png" style="height:20px; vertical-align:middle; margin-right:4px;">
                            Save
                        </button>
                    </form>
                </div>

            </div> <!-- end page-content -->
        </main>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2><img src="/static/schedule-icon.png" style="height:28px; vertical-align:middle; margin-right:6px;">Schedule File</h2>

<form id="scheduleForm" method="POST" action="/schedule"  style="width:100%;">
  <label>File:</label>
    <textarea id="scheduleFilename" name="filename" readonly rows="4"
        style="width:100%; height:60px; border:none; background-color:#f9f9f9; font-size:14px; resize:none; overflow:auto; word-wrap:break-word; white-space:pre-wrap;"></textarea>

  <table style="width:100%; margin-top:10px; border-collapse:collapse;">
  <tr>
    <td style="vertical-align:top; text-align:left; padding-right:20px; width:50%;">
      <label style="display:block; margin-bottom:4px;">Time (HH:MM):</label>
        <input type="text" id="scheduleTime" name="time"
        style="width:120px; margin-bottom:10px;"
        placeholder="HH:MM">

      <label style="display:flex; align-items:left; gap:4px; margin-bottom:4px; font-weight:normal;">
        <input type="radio" class="scheduleMode" name="mode" value="Daily" style="margin:0; padding:0;"> Daily
      </label>

      <label style="display:flex; align-items:left; gap:4px; margin-bottom:4px; font-weight:normal;">
        <input type="radio" class="scheduleMode" name="mode" value="Weekly" style="margin:0; padding:0;"> Weekly
      </label>

      <div id="weeklyDays" style="margin-top:10px; display:none;">
        <label><input type="checkbox" name="days" value="mon"> Mon</label>
        <label><input type="checkbox" name="days" value="tue"> Tue</label>
        <label><input type="checkbox" name="days" value="wed"> Wed</label>
        <label><input type="checkbox" name="days" value="thu"> Thu</label>
        <label><input type="checkbox" name="days" value="fri"> Fri</label>
        <label><input type="checkbox" name="days" value="sat"> Sat</label>
        <label><input type="checkbox" name="days" value="sun"> Sun</label>
      </div>
    </td>

    <td style="vertical-align:top; text-align:left; width:50%;">
      <label style="display:block; margin-bottom:4px;">Interval (minutes):</label>
      <input type="number" id="scheduleInterval" name="interval" min="1" style="width:120px;">
    </td>
  </tr>
</table>

  <div style="margin-top:15px; display:flex; gap:10px;">
    <button type="submit" id="scheduleSubmit" class="table-btn" style="width:120px;">
      <img src="/static/saveicontransparent.png" style="height:20px; vertical-align:middle; margin-right:4px;">Save Schedule
    </button>
    <button type="button" id="clearScheduleBtn" class="table-btn" style="background:#d9534f; color:white; width:120px;">
      Clear Schedule
    </button>
  </div>
</form>

      </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script>
        /* ---------- Helper references ---------- */
        const sections = {
            section1: document.getElementById('section1'),
            section2: document.getElementById('section2'),
            section3: document.getElementById('section3'),
            section4: document.getElementById('section4'),
            section5: document.getElementById('section5'),
            section7: document.getElementById('section7'),
            section6: document.getElementById('section6')
        };

        const buttons = {
            section1: document.getElementById('btn-section1'),
            section2: document.getElementById('btn-section2'),
            section3: document.getElementById('btn-section3'),
            section4: document.getElementById('btn-section4'),
            section5: document.getElementById('btn-section5'),
            section7: document.getElementById('btn-section7'),
            section6: document.getElementById('btn-section6')
        };

        /* ---------- Show/activate a section ---------- */
        function showSection(sectionId) {
            Object.keys(sections).forEach(key => {
                sections[key].classList.remove('active');
                if (buttons[key]) buttons[key].classList.remove('active');
            });
            if (sections[sectionId]) {
                sections[sectionId].classList.add('active');
                if (buttons[sectionId]) buttons[sectionId].classList.add('active');
                history.replaceState(null, '', '#' + sectionId);
            }
        }

        /* Attach button click handlers (safely only if they exist) */
        Object.keys(buttons).forEach(key => {
            const btn = buttons[key];
            if (btn) btn.addEventListener('click', () => showSection(key));
        });

        /* On load: pick section from hash or default */
        window.addEventListener("DOMContentLoaded", () => {
            // fetch default model to initialize dropdown
            fetch('/getmodel')
            .then(res => res.json())
            .then(data => {
                if (data.default_model) {
                    const s = document.getElementById('llmSelect');
                    if (s) s.value = data.default_model;
                }
            })
            .catch(err => console.error('Failed to fetch default model:', err));

            const hash = window.location.hash.substring(1);
            if (hash && sections[hash]) {
                showSection(hash);
            } else {
                showSection('section2'); // default section
            }
        });

        /* ---------- Login popup handling ---------- */
        let lastLoginBtn = null;
        function openLoginPopup(btn) {
            lastLoginBtn = btn;
            const popup = window.open("/login", "LoginWindow", "width=600,height=700");
            if (!popup) alert("Please allow popups for this site.");
        }
        window.addEventListener("message", function(e) {
            if (e.data === "login-success" && lastLoginBtn) {
                lastLoginBtn.textContent = "✅ Authorized"; lastLoginBtn.title = "Logged in";
            } else if (e.data === "login-failed" && lastLoginBtn) {
                lastLoginBtn.textContent = "❌ Authorization Failed"; lastLoginBtn.title = "Login failed";
            }
        });

        /* ---------- Schedule modal and mutual exclusivity ---------- */
        const scheduleTime = document.getElementById("scheduleTime");
        const scheduleInterval = document.getElementById("scheduleInterval");
        const modeCheckboxes = document.querySelectorAll(".scheduleMode");

        function enforceMutualExclusivity() {
            const timeVal = scheduleTime.value.trim();
            const intervalVal = scheduleInterval.value.trim();

            scheduleTime.disabled = !!intervalVal;
            scheduleInterval.disabled = !!timeVal;

            modeCheckboxes.forEach(cb => cb.disabled = !!intervalVal);

            document.getElementById("scheduleSubmit").disabled = !(timeVal || intervalVal);
        }

        if (scheduleTime) scheduleTime.addEventListener("input", enforceMutualExclusivity);
        if (scheduleInterval) scheduleInterval.addEventListener("input", enforceMutualExclusivity);

        function openSchedule(filename) {
            const sched = scheduleData[filename];

            document.getElementById("scheduleFilename").value = filename;
            document.getElementById("scheduleTime").value = sched && sched.time ? sched.time : "";
            document.getElementById("scheduleInterval").value = sched && sched.interval ? sched.interval : "";

            // Clear radios
            document.querySelectorAll("input[name='mode']").forEach(r => r.checked = false);

            if (sched && sched.mode) {
                const el = document.querySelector(`input[name='mode'][value='${sched.mode}']`);
                if (el) el.checked = true;

                if (sched.mode.toLowerCase() === "weekly") {
                    document.getElementById("weeklyDays").style.display = "block";
                } else {
                    document.getElementById("weeklyDays").style.display = "none";
                }
            } else {
                document.getElementById("weeklyDays").style.display = "none";
            }

            document.querySelectorAll("#weeklyDays input[type=checkbox]").forEach(cb => cb.checked = false);
            if (sched && sched.days) {
                sched.days.forEach(day => {
                    const cb = document.querySelector(`#weeklyDays input[value='${day}']`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById("scheduleModal").style.display = "block";
            enforceMutualExclusivity();
        }

        document.querySelector(".close").onclick = function() {
            document.getElementById("scheduleModal").style.display = "none";
        };
        window.onclick = function(event) {
            if (event.target === document.getElementById("scheduleModal")) {
                document.getElementById("scheduleModal").style.display = "none";
            }
        };

        function showToast(message, success=true) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.style.backgroundColor = success ? "#4CAF50" : "#d9534f";
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        /* ---------- Schedule form submit ---------- */
        document.getElementById("scheduleForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const time = scheduleTime.value.trim();
            const interval = scheduleInterval.value.trim();
            if (!time && !interval) { showToast("❌ Enter time or interval", false); return; }

            const formData = new FormData(this);

            // Selected mode (radio)
            let selectedMode = "";
            document.querySelectorAll("input[name='mode']").forEach(r => { if (r.checked) selectedMode = r.value; });
            formData.append("mode", selectedMode);

            fetch(this.action, { method: "POST", body: formData })
            .then(response => {
                if (response.ok) {
                    showToast("✅ Schedule saved successfully");
                    document.getElementById("scheduleModal").style.display = "none";
                    location.reload();
                } else {
                    showToast("❌ Failed to save schedule", false);
                }
            })
            .catch(() => showToast("❌ Error connecting to server", false));
        });

        /* ---------- Clear schedule ---------- */
        const clearScheduleBtn = document.getElementById("clearScheduleBtn");
        clearScheduleBtn.addEventListener("click", function() {
            const filename = document.getElementById("scheduleFilename").value;
            if (!filename) return;
            if (!confirm(`Clear schedule for ${filename}?`)) return;

            fetch('/schedule/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast("✅ Schedule cleared");
                    document.getElementById("scheduleModal").style.display = "none";
                    location.reload();
                } else {
                    showToast("❌ Failed to clear schedule", false);
                }
            })
            .catch(() => showToast("❌ Error connecting to server", false));
        });

        // ensure only one "mode" radio selected — radios behave this way by default, but keep mutual exclusivity for compatibility
        modeCheckboxes.forEach(cb => {
            cb.addEventListener("change", function() {
                if (this.checked) {
                    modeCheckboxes.forEach(other => {
                        if (other !== this) other.checked = false;
                    });
                }
            });
        });

        flatpickr("#scheduleTime", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true
        });

        document.querySelectorAll("input[name='mode']").forEach(radio => {
            radio.addEventListener("change", function() {
                const weeklyDaysDiv = document.getElementById("weeklyDays");
                if (this.value.toLowerCase() === "weekly") {
                    weeklyDaysDiv.style.display = "block";
                } else {
                    weeklyDaysDiv.style.display = "none";
                }
            });
        });

        /* ---------- Data injected from server ---------- */
        const scheduleData = {{ schedule_dict | tojson }};

        /* ---------- LLM select toggle ---------- */
        const llmSelect = document.getElementById('llmSelect');
        const openaiTokenField = document.getElementById('openaiTokenField');
        function toggleTokenField() {
            if (!llmSelect) return;
            if (llmSelect.value === 'OpenAI') {
                openaiTokenField.style.display = 'block';
            } else {
                openaiTokenField.style.display = 'none';
            }
        }
        if (llmSelect) {
            toggleTokenField();
            llmSelect.addEventListener('change', toggleTokenField);
        }

        /* ---------- LLM form submit (AJAX) ---------- */
        const llmForm = document.getElementById('llmForm');
        if (llmForm) {
            llmForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const selectedModel = document.getElementById('llmSelect').value;
                const openaiToken = document.querySelector('input[name="openai_token"]') ? document.querySelector('input[name="openai_token"]').value : '';

                fetch('/setmodel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        llm_model: selectedModel,
                        openai_token: openaiToken
                    })
                })
                .then(res => {
                    if (res.ok) {
                        showToast(`✅ Saved LLM model: ${selectedModel}`);
                        setTimeout(() => { window.location.hash = "section4"; window.location.reload(); }, 900);
                    } else {
                        showToast('❌ Failed to save settings', false);
                    }
                })
                .catch(() => showToast('❌ Error connecting to server', false));
            });
        }

        /* ---------- Jira form: AJAX submit ---------- */
        const jiraForm = document.querySelector('#section1 form.left-form');
        if (jiraForm) {
            jiraForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = {
                    jira_url: this.querySelector('input[name="jira_url"]').value,
                    jira_user: this.querySelector('input[name="jira_user"]').value,
                    jira_token: this.querySelector('input[name="jira_token"]').value
                };
                fetch('/save_jira', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) showToast('✅ Jira settings saved');
                    else showToast('❌ Failed to save Jira settings', false);
                })
                .catch(() => showToast('❌ Error connecting to server', false));
            });
        }

        /* ---------- Add Sharepoint (AJAX) ---------- */
        const addSharepointForm = document.querySelector('form[action="/add_sharepoint"]');
        if (addSharepointForm) {
            addSharepointForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section2"; window.location.reload(); }, 900);
                    } else {
                        showToast(`❌ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("❌ Error connecting to server", false));
            });
        }

        /* ---------- Remove sharepoint (AJAX) ---------- */
        document.querySelectorAll('form[action="/remove_sharepoint"]').forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section2"; window.location.reload(); }, 900);
                    } else {
                        showToast(`❌ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("❌ Error connecting to server", false));
            });
        });

        /* ---------- Add local (AJAX) ---------- */
        const localForm = document.querySelector('form[action="/add_local"]');
        if (localForm) {
            localForm.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section5"; window.location.reload(); }, 900);
                    } else {
                        showToast(`❌ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("❌ Error connecting to server", false));
            });
        }

        /* ---------- Remove local (AJAX) ---------- */
        document.querySelectorAll('form[action="/remove_local"]').forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, { method: "POST", body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast(`✅ ${data.message}`);
                        setTimeout(() => { window.location.hash = "section5"; window.location.reload(); }, 900);
                    } else {
                        showToast(`❌ ${data.message || "Operation failed"}`, false);
                    }
                })
                .catch(() => showToast("❌ Error connecting to server", false));
            });
        });

        document.querySelectorAll("form input[name='resync_bar']").forEach(input => {
        const form = input.closest("form");
        form.addEventListener("submit", () => {
            document.getElementById("loadingModal").style.display = "block";
        });
        });

    </script>
</body>
</html>
